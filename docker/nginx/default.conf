server {
    listen 80;
    listen [::]:80;

    # 🚨 修正: NginxのrootをLaravelのpublicディレクトリに設定 🚨
    # これにより /index.php が正しく解決される
    root /var/www/backend/public; 
    index index.php;

    # Gzip圧縮設定 (省略) ...

    # ================================================
    # 1. Nuxt静的アセットの配信 (例: /_nuxt/)
    # ================================================
    # Nuxtのビルド成果物（CSS/JS/画像など）のパスを直接指定して配信する
    location ~ ^/(_nuxt/|favicon.ico) {
        # 🚨 修正: Nuxtのビルド成果物があるパスを直接エイリアスで指定 🚨
        # phpコンテナにマウントされている ./frontend/.output/public と同じ場所
        alias /var/www/frontend/public/$1; 
        try_files $uri =404;
    }

    # ================================================
    # 2. SSRとAPIのフォールバック
    # ================================================
    location / {
        # 静的ファイルがない場合、Laravelのindex.phpにリクエストを渡す
        # rootが /var/www/backend/public のため、/index.php は正しく解決される
        try_files $uri $uri/ /index.php$is_args$args;
    }

    # ================================================
    # 3. index.php の処理（FastCGIプロキシ）
    # ================================================
    location ~ ^/index.php(/|$) {
        fastcgi_pass php:9000;
        
        fastcgi_read_timeout 300; 
        fastcgi_send_timeout 300;
        
        # FastCGIパラメータの設定
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
    }
}