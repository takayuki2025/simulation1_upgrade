server {
    listen 80;
    server_name localhost;

    # ğŸš¨ ãƒ¡ã‚¤ãƒ³ã®rootã¯/publicã«å›ºå®šã™ã‚‹
    root /var/www/backend/public; 

    index index.php index.html;

    charset utf-8;

    # 1. ã™ã¹ã¦ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’index.phpã«æ¸¡ã—ã€Laravelã®ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’ä½¿ç”¨
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }

    # 2. é™çš„ã‚¢ã‚»ãƒƒãƒˆï¼ˆCSS, JS, ç”»åƒ, SVGãªã©ï¼‰ã®å‡¦ç†
    location ~* \.(css|js|jpe?g|gif|png|svg|ico)$ {
        try_files $uri =404;
        access_log off;
        log_not_found off;
        expires max; 
    }

    # ğŸ’¡ ULTIMATE FIX 4.0: aliasã‚’ä½¿ç”¨ã—ã€locationã®URIã‚’ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã§çµ‚ã‚ã‚‰ã›ã‚‹
    # ã“ã‚Œã«ã‚ˆã‚Šã€Nginxã¯URIã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰ã›ãšã«ã€aliasã®ãƒ‘ã‚¹ã«ã€Œãã®ã¾ã¾ã€çµåˆã—ã‚ˆã†ã¨ã—ã¾ã™ã€‚
    # ã“ã®æ–¹æ³•ãŒã€+ã‚„æ—¥æœ¬èªæ–‡å­—ã®ãƒ•ã‚¡ã‚¤ãƒ«åã‚’æœ€ã‚‚ç¢ºå®Ÿã«å–ã‚Šæ‰±ãˆã‚‹ã¯ãšã§ã™ã€‚
    location /storage/item_images/ {
        # ãƒªã‚¯ã‚¨ã‚¹ãƒˆURIã® /storage/item_images/ ã‚ˆã‚Šå¾Œã‚’
        # /var/www/backend/storage/app/public/item_images/ ã®å¾Œã«ãã®ã¾ã¾çµåˆã™ã‚‹
        alias /var/www/backend/storage/app/public/item_images/; 
        
        # aliasã‚’ä½¿ã†ãŸã‚ã€try_files ã¯ä¸è¦ã§ã™ (NginxãŒaliasã®ãƒ‘ã‚¹ã‚’ç›´æ¥æ¢ã—ã¾ã™)
        access_log off;
        log_not_found off;
        expires max;
    }


    # 3. PHPãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç† (php-fpmã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ¸¡ã™)
    location ~ \.php$ {
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass php:9000; 
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        fastcgi_param PATH_INFO $fastcgi_path_info;
        
        fastcgi_buffers 16 16k;
        fastcgi_buffer_size 32k;
    }

    # 4. .htaccessãªã©ã®éš ã—ãƒ•ã‚¡ã‚¤ãƒ«ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ‹’å¦
    location ~ /\. {
        deny all;
    }
}