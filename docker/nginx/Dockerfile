# --- STAGE 1: nuxt_builder (Nuxtã®ãƒ“ãƒ«ãƒ‰ã¯æ®‹ã—ã¾ã™) ---
FROM node:22-bullseye AS nuxt_builder
# ... (æ—¢å­˜ã®ãƒ“ãƒ«ãƒ‰å‡¦ç†ã¯ãã®ã¾ã¾ã€‚ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ä½œã‚‹ã®ãŒç›®çš„)
RUN npm run build
# ...

# ----------------------------------------------------

# --- STAGE 2: Nginx Production Image ---
FROM nginx:1.21.1 as stage-1

# Nginxè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚³ãƒ”ãƒ¼ (ä¿®æ­£ã—ãŸdefault.confã‚’ä½¿ç”¨)
COPY docker/nginx/nginx.conf /etc/nginx/nginx.conf
COPY docker/nginx/default.conf /etc/nginx/conf.d/default.conf

# ğŸš¨ ä¿®æ­£: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã®ã‚³ãƒ”ãƒ¼ã‚’å‰Šé™¤ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ ğŸš¨
# docker-compose.ymlã§ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒã‚¦ãƒ³ãƒˆã™ã‚‹ãŸã‚ã€ã“ã“ã§ã¯ã‚³ãƒ”ãƒ¼ã—ã¾ã›ã‚“ã€‚
# COPY --from=nuxt_builder /app/.output /var/www/frontend 

# NginxãŒã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨­å®š
# /var/www/frontend ã¯ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹ãŸã‚ã€backendã®ã¿ã«é™å®š
# RUN chown -R nginx:nginx /var/www/frontend # <-- ã“ã®è¡Œã‚’å‰Šé™¤ã¾ãŸã¯ä¿®æ­£

# ğŸš¨ ä¿®æ­£: ãƒã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™è¨­å®šã¯å¿…é ˆ ğŸš¨
# backend ã¨ frontend/public ã®ä¸¡æ–¹ãŒ www-data (PHP) ã¨ nginx ã§ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ã™ã‚‹
# Nginxã‚³ãƒ³ãƒ†ãƒŠã§ã¯ /var/www/frontend/public ã¯ç©ºã§èµ·å‹•ã—ã€phpã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰ãƒã‚¦ãƒ³ãƒˆã•ã‚Œã‚‹ãŸã‚ã€
# phpã‚³ãƒ³ãƒ†ãƒŠã‹ã‚‰å…±æœ‰ã•ã‚Œã‚‹ /var/www/frontend/public ã®æ¨©é™ã¯ phpã‚³ãƒ³ãƒ†ãƒŠå´ã§è¨­å®šã•ã‚Œã¾ã™ã€‚
# ã“ã“ã§ã¯ NginxãŒæ“ä½œã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ¨©é™ã®ã¿ã‚’ä¿®æ­£ã€‚
RUN mkdir -p /var/www/backend /var/www/frontend/public && \
    chown -R nginx:nginx /var/www/backend /var/www/frontend/public

# Nginxã®å®Ÿè¡Œãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆã¨ãã®ä»–ã®æ¨©é™è¨­å®š (æ—¢å­˜ã®å†…å®¹)
RUN mkdir -p /var/cache/nginx/client_temp /var/run /var/log/nginx && \
    chown -R nginx:nginx /var/cache/nginx /var/run /var/log/nginx

# å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’nginxã«å¤‰æ›´ (æ—¢å­˜ã®å†…å®¹)
USER nginx